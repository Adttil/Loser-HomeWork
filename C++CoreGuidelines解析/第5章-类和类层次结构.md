# 类和类的层次结构

类和类的层次结构规则概览：

- [类和类的层次结构](#类和类的层次结构)
  - [5.1 概要规则](#51-概要规则)
    - [C.1 把相关的数据组织到结构（struct 或 class）中](#c1-把相关的数据组织到结构struct-或-class中)
    - [C.2 当类具有不变式时使用 class；如果数据成员可以独立变化，则使用 struct](#c2-当类具有不变式时使用-class如果数据成员可以独立变化则使用-struct)

类是一种用户定义类型，程序员可以为其指定表示方法、操作和接口。类的层次结构被用来组织相关的结构。

C++ Core Guidelines 中大约有100条关于用户定义类型的规则。

Guidelines 先给出了一些概要规则，然后深入讨论了下面的特殊规则：

- 具体类型
- 构造函数、赋值和析构函数
- 类的层次结构
- 重载和运算符重载
- 联合体

下面的 8 条概要规则为特殊规则提供了背景。

## 5.1 概要规则

概要规则相当简短，没有涉及太多细节。它们对类概括提供了有价值的深刻见解。

> **class（类）和struct（结构体）之间的语法差异**
> 本节经常提到类和结构体之间的语义区别。首先。语法上的差异是什么？差异很小，但很重要：
> - 在结构体中，所有成员默认为 public（公开）；类为（private）私有。
> - 继承情况也是如此。结构体默认继承权限为 public，类为 private。

**除此之外，二者在语言语法层面完全一致**。

### C.1 把相关的数据组织到结构（struct 或 class）中

如何改进 draw 的接口？

```cpp
void draw(int fromX, int fromY, int toX, int toY);
```

不明显的是，这些 int 代表了什么。因此，调用函数的时候参数顺序可能会出错。可以对比一下上面的 draw 和下面的新函数：

```cpp
void draw(Point from, Point to);
```

通过将相关元素放在结构体中，函数签名变得可以自我描述，因此，比起之前的函数，新函数更不容易出错。

> 类对象的构造函数也可以用来检测参数的合法性，不过这里的 Point 类型倒是没啥好检测的了。

### C.2 当类具有不变式时使用 class；如果数据成员可以独立变化，则使用 struct

>不变式（Invariant）是一个在程序执行过程中永远保持成立的条件。不变式在检测程序是否正确方面非常有用。例如编译器优化就用到了不变式。

类的不变式是用于约束类的实例的不变式。成员函数必须使这个不变式保持成立。
不变式约束了类的实例的可能取值。

这是 C++ 中一个常见的问题：*什么时候该使用 class，什么时候该用 struct？*

C++ Core Guidelines 给出了以下建议。**如果类有不变式，就使用 class**。

> **如果类有一个需要在程序执行过程中永远保持成立的条件，就使用 class**。

一个可能的类的不变式是，（y，m，d）可表示一个有效的日期。

```cpp
struct Pair{  //成员可以独立变化
    string name;
    int volume;
};

class Date{
public:
    //校验 {yy，mm，dd}是不是合法的日期并进行初始化
    Date(int yy, Month mm, char dd);
    // ...
private:
    int y;
    Month m;
    char d;    //日
}
```

类的不变式在构造函数中被初始化和检查。数据类型 Pair 没有不变式，因为名称（name）和体积（volume）的所有值都是有效的。Pair 是简单的数据持有者，不需要显式提供构造函数。

> 值得一提的是，很多库并没有很好的遵守，我们举例 [QPoint](https://doc.qt.io/qt-6/qpoint.html)，[源码](https://codebrowser.dev/qt5/qtbase/src/corelib/tools/qpoint.h.html)。

QPoint 显然是没有不变式，它的成员（xp，yp）所有的值都是有效的，但它依旧使用的是 class。
以及，它没有将它的数据成员设置为 public，反而提供了愚蠢的 6 个成员函数进行访问：`rx，ry，x，y，setX，setY`。
